name: Refresh Release Assets

on:
  schedule:
    # Monthly Schedule: Runs at 00:00 on day 1 of every month
    - cron: '0 0 1 * *'
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  refresh-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Process Assets and Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Versioning Logic: YearMonthDay for internal tracking
          VERSION=$(date +%Y%m%d)
          echo "Processing version: $VERSION"

          # 2. Flattening Logic: Check for single wrapper folder in app/assets
          if [ -d "app/assets" ]; then
            SUB_DIRS=$(ls -d app/assets/*/ 2>/dev/null | wc -l)
            FILES=$(ls -p app/assets | grep -v / | wc -l)
            
            # If there is exactly 1 directory and 0 files in the root of assets
            if [ "$SUB_DIRS" -eq 1 ] && [ "$FILES" -eq 0 ]; then
              WRAPPER=$(ls -d app/assets/*/ | head -n 1)
              echo "Flattening: Moving contents from $WRAPPER to app/assets/"
              mv "$WRAPPER"* app/assets/
              rmdir "$WRAPPER"
            fi
          fi

          # 3. Tag Force-Delete: Logic Preservation to avoid "Tag already exists"
          git tag -d ∞ || true
          git push origin :refs/tags/∞ || true

          # 4. Remove existing release to allow clean overwrite
          gh release delete ∞ --yes || true

          # 5. Create Release: Title "V∞" with YearMonthDay in notes
          # Logic: README.md is the primary source for release notes
          gh release create ∞ \
            --title "V∞" \
            --notes "Release Version: $VERSION | Notes: $(cat app/README.md 2>/dev/null || echo 'Monthly automated update.')" \
            app/assets/*
            
