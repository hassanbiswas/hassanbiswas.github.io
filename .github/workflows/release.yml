name: Refresh Release Assets

on:
  # Manual trigger for anytime execution
  workflow_dispatch:
  # Automation: Runs at 00:00 on Jan 1st and July 1st
  schedule:
    - cron: '0 0 1 1,7 *'

permissions:
  contents: write

jobs:
  refresh-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cleanup Old Drafts and Refresh Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Automate cleanup of all existing drafts
          echo "Cleaning up old drafts..."
          gh release list --limit 100 --json isDraft,tagName | \
          jq -r '.[] | select(.isDraft == true) | .tagName' | \
          xargs -I {} sh -c 'if [ -n "{}" ]; then gh release delete "{}" --yes; fi' || true

          # 2. Force-delete existing "∞" release and remote tag
          echo "Removing existing ∞ release..."
          gh release delete "∞" --yes --cleanup || true
          git push origin :refs/tags/∞ --delete || true

          # 3. Brief pause for GitHub database reconciliation
          sleep 5

          # 4. Create the new release using logic automation
          echo "Creating new ∞ release..."
          if [ -f "app/README.md" ]; then
            gh release create "∞" \
              --title "v ∞" \
              --notes-file app/README.md \
              --target main \
              --latest
          else
            gh release create "∞" \
              --title "v ∞" \
              --notes "Automated asset release for hassanbiswas.github.io" \
              --target main \
              --latest
          fi

          # 5. Upload assets safely from app/assets
          if [ -d "app/assets" ] && [ "$(ls -A app/assets 2>/dev/null)" ]; then
            echo "Uploading assets..."
            gh release upload "∞" app/assets/* --clobber
          else
            echo "No assets found. Skipping upload."
          fi
          
