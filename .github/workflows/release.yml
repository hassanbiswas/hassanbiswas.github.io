name: Refresh Release Assets

on:
  # Monthly Schedule: Runs at 00:00 on day 1 of every month
  schedule:
    - cron: '0 0 1 * *'
  
  # Manual Trigger: Allows you to run it manually from the Actions tab
  workflow_dispatch:

permissions:
  contents: write

jobs:
  refresh-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cleanup and Flatten Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Logic Automation: Cache-busting version using Month
          VERSION=$(date +%m)
          echo "Automating release for Month: $VERSION"

          # 2. Flattening Logic: Move inner contents out if a single wrapper exists
          if [ -d "app/assets" ]; then
            ITEM_COUNT=$(ls -1 app/assets | wc -l)
            if [ "$ITEM_COUNT" -eq 1 ]; then
              WRAPPER_DIR=$(ls app/assets)
              if [ -d "app/assets/$WRAPPER_DIR" ]; then
                echo "Single wrapper detected: $WRAPPER_DIR"
                mv app/assets/"$WRAPPER_DIR"/* app/assets/
                rmdir app/assets/"$WRAPPER_DIR"
              fi
            fi
          fi

          # 3. Force-Delete Tag & Re-release (Logic Preservation)
          # Tag Force-Delete to prevent "Tag already exists" errors
          git tag -d ∞ || true
          git push origin :refs/tags/∞ || true
          
          # Create new release with app/README.md as source
          gh release create ∞ \
            --title "Monthly Automated Release ($VERSION)" \
            --notes-file app/README.md \
            --cleanup-tag \
            app/assets/*
            
