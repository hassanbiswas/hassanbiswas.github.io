name: Refresh Release Assets

on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    # Runs at 00:00 on day-of-month 1 and 15 (Half-monthly automation)
    - cron: '0 0 1,15 * *'

permissions:
  contents: write

jobs:
  refresh-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cleanup and Flatten Assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Logic Automation: Cache-busting version based on Date
          VERSION=$(date +%d)
          echo "Automating release for version/day: $VERSION"

          # 2. Flattening Logic: Check for single wrapper folder in app/assets
          if [ -d "app/assets" ]; then
            COUNT=$(ls -1 app/assets | wc -l)
            if [ "$COUNT" -eq 1 ] && [ -d "app/assets/$(ls app/assets)" ]; then
              echo "Single wrapper detected. Flattening..."
              SUBFOLDER=$(ls app/assets)
              mv app/assets/"$SUBFOLDER"/* app/assets/
              rmdir app/assets/"$SUBFOLDER"
            fi
          fi

          # 3. Cleanup existing drafts and specific "∞" release
          gh release list --limit 100 --json isDraft,tagName | \
          jq -r '.[] | select(.isDraft == true) | .tagName' | \
          xargs -I {} sh -c 'if [ -n "{}" ]; then gh release delete "{}" --yes; fi' || true

          gh release delete "∞" --yes --cleanup || true
          git push origin :refs/tags/∞ --delete || true

          sleep 5

          # 4. Create new release with Logic Preservation
          NOTES="Automated asset release for hassanbiswas.github.io - Updated on day $VERSION"
          if [ -f "app/README.md" ]; then
            gh release create "∞" \
              --title "v ∞" \
              --notes-file app/README.md \
              --target main \
              --latest
          else
            gh release create "∞" \
              --title "v ∞" \
              --notes "$NOTES" \
              --target main \
              --latest
          fi

          # 5. Upload assets safely
          if [ -d "app/assets" ] && [ "$(ls -A app/assets 2>/dev/null)" ]; then
            echo "Uploading flattened assets..."
            gh release upload "∞" app/assets/* --clobber
          else
            echo "No assets found. Skipping upload."
          fi
          
