name: SEO & Manifest Automation

on:
  push:
    branches: [ main ]
  schedule:
    # Automation: Runs every Sunday at 00:00 UTC (Weekly Schedule)
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allows manual trigger if needed

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate SEO Assets
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');

          // Logic-based versioning for automation
          const VERSION = new Date().getDate();
          const VERSION_DATE = new Date().toISOString().split('T')[0];
          const BASE_URL = 'https://hassanbiswas.github.io';
          const BRAND_COLOR = 'hsl(240, 80%, 50%)';

          const CONFIG = {
            '/': { priority: 1.0, changefreq: 'weekly' },
            '/about/': { priority: 0.8, changefreq: 'monthly' },
            '/services/': { priority: 0.8, changefreq: 'monthly' },
            '/contact/': { priority: 0.7, changefreq: 'monthly' }
          };

          const EXCLUSIONS = {
            folders: ['dist', 'node_modules', '.git', '.github', 'assets', 'components', 'draft', 'error', 'freefire'],
            files: ['README.md', 'generate-assets.js', 'googledb2beed158567cde.html', 'LICENSE.txt', 'heartbeat.json']
          };

          const getHtmlFiles = (dir, fileList = []) => {
            const files = fs.readdirSync(dir);
            files.forEach(file => {
              const filePath = path.join(dir, file);
              const isDirectory = fs.statSync(filePath).isDirectory();
              if (isDirectory && EXCLUSIONS.folders.includes(file)) return;
              if (!isDirectory && EXCLUSIONS.files.includes(file)) return;

              if (isDirectory) {
                getHtmlFiles(filePath, fileList);
              } else if (file.endsWith('.html')) {
                let urlPath = filePath.replace(process.cwd(), '').replace(/\\\\/g, '/').replace(/index\.html$/, '');
                if (!urlPath.startsWith('/')) urlPath = '/' + urlPath;
                if (!urlPath.endsWith('/')) urlPath = urlPath + '/';
                fileList.push(urlPath);
              }
            });
            return [...new Set(fileList)];
          };

          // 1. SITEMAP GENERATION
          const allPages = getHtmlFiles(process.cwd());
          const sitemapEntries = allPages.map(page => {
            const settings = CONFIG[page] || { priority: 0.5, changefreq: 'monthly' };
            return '  <url>\n    <loc>' + BASE_URL + page + '</loc>\n    <lastmod>' + VERSION_DATE + '</lastmod>\n    <priority>' + settings.priority + '</priority>\n    <changefreq>' + settings.changefreq + '</changefreq>\n  </url>';
          }).join('\n');

          const sitemap = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n' + sitemapEntries + '\n</urlset>';
          fs.writeFileSync('sitemap.xml', sitemap);
          console.log('Sitemap generated for ' + allPages.length + ' pages.');
          "

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff-index --quiet HEAD || git commit -m "Automated SEO update: $(date +'%Y-%m-%d')"
          git push
          
