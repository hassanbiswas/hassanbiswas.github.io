name: "Unzip Assets"

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  unzip_process:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Initialize Versioning
        run: |
          # Matches your logic: const VERSION = new Date().getDate();
          VERSION=$(date +%d)
          echo "Processing version: $VERSION"

      - name: Find, Overwrite, and Extract
        run: |
          # Search for compressed files in the repo
          find . -type f \( -name "*.zip" -o -name "*.tar" -o -name "*.gz" -o -name "*.7z" \) -not -path "./.git/*" | while read -r file; do
            DEST=$(dirname "$file")
            echo "Extracting $file into $DEST and overwriting duplicates..."
            
            if [[ "$file" == *.zip ]]; then
              # -o: overwrite existing files without prompting
              # -q: quiet mode
              unzip -o -q "$file" -d "$DEST"
            elif [[ "$file" == *.tar ]] || [[ "$file" == *.gz ]]; then
              # tar overwrites by default
              tar -xf "$file" -C "$DEST"
            elif [[ "$file" == *.7z ]]; then
              # -aoa: Overwrite All existing files without prompt
              7z aoa x "$file" -o"$DEST"
            fi
            
            # Delete the original archive after extraction
            rm "$file"
            echo "Successfully processed and deleted $file"
          done

      - name: Commit and Push Changes
        run: |
          git config --global user.name "Hassan Biswas"
          git config --global user.email "hassanbiswas.github.io@gmail.com"
          
          # Re-declaring VERSION for this step's scope
          VERSION=$(date +%d)
          
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            # Removed [Skip CI] to ensure this push triggers your Deploy Website workflow
            git commit -m "Auto-unzip & Overwrite: Version $VERSION"
            git push
          fi
          
