name: SEO & Manifest Automation

on:
  push:
    branches: [ main ]
  # Automation: Runs every Monday at 00:00 UTC (Zero Maintenance)
  schedule:
    - cron: '0 0 * * 1' 
  workflow_dispatch: # Allows manual trigger if needed

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate SEO Assets
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');

          // Logic-based versioning
          const VERSION = new Date().getDate();
          const VERSION_DATE = new Date().toISOString().split('T')[0];
          const BASE_URL = 'https://hassanbiswas.github.io';
          const BRAND_COLOR = 'hsl(240, 80%, 50%)';

          const CONFIG = {
            '/': { priority: 1.0, changefreq: 'weekly' },
            '/about/': { priority: 0.8, changefreq: 'monthly' },
            '/services/': { priority: 0.8, changefreq: 'monthly' },
            '/contact/': { priority: 0.7, changefreq: 'monthly' }
          };

          const EXCLUSIONS = {
            folders: ['dist', 'node_modules', '.git', '.github', 'assets', 'components', 'draft', 'error', 'freefire', 'nid', 'trash'],
            files: ['README.md', 'generate-assets.js', 'googledb2beed158567cde.html', 'LICENSE.txt', 'heartbeat.json', 'lighthouserc.json', 'manifest.webmanifest', 'package.json', 'sw.js', '404.html', 'favicon.ico', 'favicon.svg', 'offline.html', '8886230f8ec14aecb0ba333e57bc135a.txt']
          };

          const getHtmlFiles = (dir, fileList = []) => {
            const files = fs.readdirSync(dir);
            files.forEach(file => {
              const filePath = path.join(dir, file);
              const isDirectory = fs.statSync(filePath).isDirectory();
              if (isDirectory && EXCLUSIONS.folders.includes(file)) return;
              if (!isDirectory && EXCLUSIONS.files.includes(file)) return;

              if (isDirectory) {
                getHtmlFiles(filePath, fileList);
              } else if (file.endsWith('.html')) {
                let urlPath = filePath.replace(process.cwd(), '').replace(/\\\\/g, '/').replace(/index\.html$/, '');
                if (!urlPath.startsWith('/')) urlPath = '/' + urlPath;
                if (!urlPath.endsWith('/')) urlPath = urlPath + '/';
                fileList.push(urlPath);
              }
            });
            return [...new Set(fileList)];
          };

          // 1. SITEMAP GENERATION
          const allPages = getHtmlFiles(process.cwd());
          const sitemapEntries = allPages.map(page => {
            const settings = CONFIG[page] || { priority: 0.5, changefreq: 'monthly' };
            return '  <url>\n    <loc>' + BASE_URL + page + '</loc>\n    <lastmod>' + VERSION_DATE + '</lastmod>\n    <changefreq>' + settings.changefreq + '</changefreq>\n    <priority>' + settings.priority.toFixed(1) + '</priority>\n  </url>';
          }).join('\n');
          const sitemap = '<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">\n' + sitemapEntries + '\n</urlset>';
          fs.writeFileSync('sitemap.xml', sitemap);

          // 2. ROBOTS.TXT GENERATION
          const robots = 'User-agent: *\nAllow: /\nDisallow: /private/\nDisallow: /drafts/\nDisallow: /node_modules/\nSitemap: ' + BASE_URL + '/sitemap.xml\n\n# Updated: ' + VERSION_DATE + ' (v' + VERSION + ')';
          fs.writeFileSync('robots.txt', robots);

          // 3. MANIFEST GENERATION (With sizes="any" for SVG scaling)
          const manifest = {
            'short_name': 'Web Developer',
            'name': 'Web Developer : Hassan Biswas',
            'description': 'Freelance Front-End Developer & Website Designer specializing in transforming Figma designs into high-performance, SEO-friendly digital experiences.',
            'start_url': '/',
            'display': 'standalone',
            'theme_color': BRAND_COLOR,
            'background_color': BRAND_COLOR,
            'orientation': 'portrait',
            'icons': [
              { 'src': 'https://lh3.googleusercontent.com/a/ACg8ocJfIX4otqilqq6qUXViOZFY1tLeGWq20Ylvch7bsP_41Kwlq20=s400-c-no', 'type': 'image/png', 'sizes': '400x400', 'purpose': 'any' },
              { 'src': 'favicon.svg', 'type': 'image/svg+xml', 'sizes': 'any', 'purpose': 'maskable' }
            ],
            'shortcuts': [
              { 'name': 'Messenger', 'url': 'https://m.me/hassanbiswas.github.io', 'icons': [{ 'src': 'https://www.google.com/s2/favicons?domain=messenger.com&sz=96', 'sizes': '96x96' }] },
              { 'name': 'Call', 'url': 'tel:+8801602873384', 'icons': [{ 'src': 'https://www.google.com/s2/favicons?domain=voice.google.com&sz=96', 'sizes': '96x96' }] },
              { 'name': 'G-mail', 'url': 'mailto:hassanbiswas.github.io@gmail.com', 'icons': [{ 'src': 'https://www.google.com/s2/favicons?domain=mail.google.com&sz=96', 'sizes': '96x96' }] }
            ],
            'screenshots': [
              { 'src': 'images/screen-1.svg', 'type': 'image/svg+xml', 'sizes': 'any' },
              { 'src': 'images/screen-2.svg', 'type': 'image/svg+xml', 'sizes': 'any' },
              { 'src': 'images/screen-3.svg', 'type': 'image/svg+xml', 'sizes': 'any' }
            ]
          };
          fs.writeFileSync('manifest.webmanifest', JSON.stringify(manifest, null, 2));
          "

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add sitemap.xml robots.txt manifest.webmanifest
          git commit -m "Weekly Automated SEO Refresh: v$(date +%d)" || echo "No changes to commit"
          git push
          
