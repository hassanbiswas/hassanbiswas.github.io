name: Deploy Website

on:
  push:
    branches: ["main"]
    paths:
      - '**'
      - '**/*.zip'
      - '**/*.7z'
      - '**/*.tar'
      - '**/*.gz'
      - '**/*.rar'

  # Logic 2: Execute every 1st and 15th (Zero Maintenance)
  schedule:
    - cron: '0 0 1,15 * *'

  # Logic 3: Allow manual execution if ever needed
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  process-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout Code
        uses: [actions/checkout@v4](https://github.com/actions/checkout)
        with:
          fetch-depth: 0

      - name: Auto-Unzip and Overwrite Process
        id: process_logic
        run: |
          # Logic: Version automation for cache-busting
          # const VERSION = new Date().getDate();
          VERSION=$(date +%d)
          echo "VERSION_ID=$VERSION" >> $GITHUB_ENV
          echo "Executing Automation for Version: $VERSION"

          # Excluded names (protecting core architecture)
          EXCLUDED_FOLDERS=("node_modules" "src/temp-assets" "backup" "app" ".git" ".github")
          EXCLUDE_CMD=""
          for folder in "${EXCLUDED_FOLDERS[@]}"; do
            EXCLUDE_CMD+=" -not -path \"*/$folder/*\" -not -name \"$folder\""
          done

          # Find and process compressed files
          FOUND_FILES=$(find . -type f \( -name "*.zip" -o -name "*.tar" -o -name "*.gz" -o -name "*.7z" -o -name "*.rar" \) $EXCLUDE_CMD)
          
          if [ -z "$FOUND_FILES" ]; then
            echo "No compressed files found."
          else
            echo "$FOUND_FILES" | while read -r file; do
              base_dir=$(dirname "$file")
              temp_extract_dir="${file%.*}_tmp"
              
              echo "Processing: $file in $base_dir"
              mkdir -p "$temp_extract_dir"

              # Extraction logic
              if [[ "$file" == *.zip ]]; then unzip -o "$file" -d "$temp_extract_dir";
              elif [[ "$file" == *.7z ]]; then 7z x "$file" -o"$temp_extract_dir" -y;
              else tar -xf "$file" -C "$temp_extract_dir"; fi

              # Logic: Delete existing duplicates before moving
              # This ensures zero maintenance and avoids stale file overlap
              ls -A "$temp_extract_dir" | while read -r item; do
                target_path="$base_dir/$item"
                if [ -e "$target_path" ]; then
                  echo "Removing existing duplicate: $target_path"
                  rm -rf "$target_path"
                fi
              done

              # Move new content and clean up
              cp -rf "$temp_extract_dir"/. "$base_dir/" 
              rm "$file"
              rm -rf "$temp_extract_dir"
              echo "Success: $file processed with Logic Preservation."
            done
          fi

      - name: Commit Asset Changes
        run: |
          # Brand: Hassan Biswas â€” UI/UX & Front-End Architecture
          git config --local user.email "hassanbiswas.github.io@gmail.com"
          git config --local user.name "Hassan Biswas"
          
          if [ -n "$(git status --porcelain)" ]; then
            git add .
            git commit -m "Automation: Unzipped & Purged Duplicates (v${{ env.VERSION_ID }}) [skip ci]"
            git push
          else
            echo "No asset changes to commit."
          fi

      - name: Setup GitHub Pages
        uses: [actions/configure-pages@v4](https://github.com/actions/configure-pages)

      - name: Upload Deployment Artifact
        uses: [actions/upload-pages-artifact@v3](https://github.com/actions/upload-pages-artifact)
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: [actions/deploy-pages@v4](https://github.com/actions/deploy-pages)
        
