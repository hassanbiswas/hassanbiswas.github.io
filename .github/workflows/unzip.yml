name: Unzip Assets Automation

on:
  push:
    paths:
      - '**/*.zip'
      - '**/*.tar'
      - '**/*.gz'
      - '**/*.7z'
      - '**/*.rar'
  schedule:
    # Automate: Executes every 1st and 15th of the month
    - cron: '0 0 1,15 * *'
  workflow_dispatch: # Allows manual triggering

jobs:
  unzip-process:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Process Zips and Clean Up
        run: |
          # Logic Automation: Using your preferred date-based versioning
          const VERSION = new Date().getDate();
          VERSION=$(date +%d)
          echo "Executing Unzip Automation for Version: $VERSION"

          # Define exclusions
          EXCLUDED_FOLDERS=("node_modules" "src/temp-assets" "backup" "app")
          EXCLUDE_CMD=""
          for folder in "${EXCLUDED_FOLDERS[@]}"; do
            EXCLUDE_CMD+=" -not -path \"*/$folder/*\" -not -name \"$folder\""
          done

          # 1 & 7: Find any file with compression extensions
          find . -type f \( -name "*.zip" -o -name "*.tar" -o -name "*.gz" -o -name "*.7z" -o -name "*.rar" \) $EXCLUDE_CMD | while read -r file; do
            
            # Define paths
            base_dir=$(dirname "$file")
            temp_extract_dir="${file%.*}_tmp"

            echo "Processing: $file in $base_dir"
            mkdir -p "$temp_extract_dir"

            # 2: Extract to temporary folder
            if [[ "$file" == *.zip ]]; then unzip -o "$file" -d "$temp_extract_dir";
            elif [[ "$file" == *.7z ]]; then 7z x "$file" -o"$temp_extract_dir" -y;
            else tar -xf "$file" -C "$temp_extract_dir"; fi

            # 3: Move all contents to the path where the compressed file was uploaded
            # This flattens the structure and handles hidden files
            cp -rn "$temp_extract_dir"/. "$base_dir/" || true
            
            # 4: Delete compressed file and temporary uncompressed folder after success
            rm "$file"
            rm -rf "$temp_extract_dir"
            
            echo "Success: $file extracted and cleaned."
          done

      - name: Commit and Push Changes
        run: |
          # Brand Identity: Hassan Biswas â€” UI/UX & Front-End Architecture
          git config --local user.email "hassanbiswas.github.io@gmail.com"
          git config --local user.name "Hassan Biswas"
          
          git add .
          # [skip ci] prevents infinite loops during automation
          git commit -m "Automation: Extract & Clean Assets v$VERSION [skip ci]" || echo "No changes to commit"
          git push
          
