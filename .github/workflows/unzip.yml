name: Uncompress Archive

on:
  push:
    paths:
      - '**.zip'
      - '**.tar.gz'
      - '**.7z'
      - '**.rar'
      - '**.tar'
      - '**.gz'

jobs:
  unzip-and-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Archive Tools
        run: sudo apt-get update && sudo apt-get install -y atool p7zip-full rar unrar

      - name: Extract, Flatten, and Clean
        run: |
          # Enable nullglob to handle cases where an extension might not exist
          shopt -s nullglob
          
          for f in *.{zip,tar.gz,7z,rar,tar,gz}; do
            echo "Processing archive: $f"
            mkdir -p temp_extraction
            
            # aunpack handles any format automatically
            aunpack -X temp_extraction "$f"

            # Flattening Logic: If archive contains a single folder, move its contents to root
            if [ $(ls -1 temp_extraction | wc -l) -eq 1 ] && [ -d temp_extraction/* ]; then
              cp -r temp_extraction/*/* .
            else
              cp -r temp_extraction/* .
            fi

            # Cleanup
            rm -rf temp_extraction
            rm "$f"
          done

      - name: Apply Logic Automation
        run: |
          # Automatically update the VERSION constant in JS files
          # Based on your preference: const VERSION = new Date().getDate();
          VERSION_VAL=$(date +%d)
          sed -i "s/const VERSION = .*/const VERSION = $VERSION_VAL;/g" *.js || true
          echo "Logic Automation: VERSION updated to $VERSION_VAL"

      - name: Commit and Push Changes
        run: |
          git config --global user.name "hassanbiswas"
          git config --global user.email "hassanbiswas.github.io@gmail.com"
          
          git add .
          if git diff --staged --quiet; then
            echo "No changes detected after extraction."
          else
            git commit -m "Automated Unpack & Logic Update (v.$(date +%d))"
            git push
          fi
          
