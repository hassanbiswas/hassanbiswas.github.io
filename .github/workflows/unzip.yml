name: Uncompress Archive

on:
  push:
    paths:
      - '**.zip'
      - '**.tar.gz'
      - '**.7z'
      - '**.rar'
      - '**.tar'
      - '**.gz'

jobs:
  unzip-and-sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Archive Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y atool p7zip-full rar unrar

      - name: Extract, Flatten, and Clean
        run: |
          shopt -s dotglob nullglob
          
          # Find all supported archives
          for f in *.{zip,tar.gz,7z,rar,tar,gz}; do
            echo "Working on: $f"
            mkdir -p temp_extraction
            
            # Extract to temp folder
            aunpack -e -X temp_extraction "$f"

            # Improved Flattening: Check if there's only one item and it's a directory
            CONTENT_COUNT=$(ls -1 temp_extraction | wc -l)
            if [ "$CONTENT_COUNT" -eq 1 ] && [ -d temp_extraction/*/ ]; then
              echo "Single directory detected. Flattening..."
              mv temp_extraction/*/* .
            else
              echo "Multiple items or files detected. Moving to root..."
              mv temp_extraction/* .
            fi

            # Cleanup
            rm -rf temp_extraction
            rm "$f"
          done

      - name: Apply Logic Automation
        run: |
          # Updating the VERSION constant based on your preference
          # const VERSION = new Date().getDate();
          VERSION_VAL=$(date +%-d)
          # Matches 'const VERSION = ' followed by any value or quote
          sed -i "s/const VERSION = [^;]*/const VERSION = $VERSION_VAL/g" *.js || true
          echo "Logic Automation: VERSION synchronized to $VERSION_VAL"

      - name: Commit and Push Changes
        run: |
          git config --global user.name "hassanbiswas"
          git config --global user.email "hassanbiswas.github.io@gmail.com"
          
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            # Using your brand color logic context for the commit if desired
            git commit -m "chore: unpack archives & update logic to v.$VERSION_VAL"
            git push
          fi
          
