name: Auto Update Sitemap

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 0 * * *' # Runs every day at midnight
  workflow_dispatch: 

jobs:
  sitemap:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Generate Sitemap (Internal Logic)
        shell: node {0}
        run: |
          const fs = require('fs');
          const path = require('path');

          const VERSION_DATE = new Date().toISOString().split('T')[0];
          const BASE_URL = 'https://hassanbiswas.github.io';
          
          const CONFIG = {
            '/': { priority: 1.0, changefreq: 'weekly' },
            '/about/': { priority: 0.8, changefreq: 'monthly' },
            '/services/': { priority: 0.8, changefreq: 'monthly' },
            '/contact/': { priority: 0.7, changefreq: 'monthly' }
          };

          // Your 3 example folders and 3 example files to exclude
          const EXCLUSIONS = {
            folders: ['node_modules', '.git', 'dist'],
            files: ['404.html', 'test.html', 'draft.html']
          };

          const getHtmlFiles = (dir, fileList = []) => {
            const files = fs.readdirSync(dir);
            files.forEach(file => {
              const filePath = path.join(dir, file);
              const isDirectory = fs.statSync(filePath).isDirectory();

              if (isDirectory && EXCLUSIONS.folders.includes(file)) return;
              if (!isDirectory && EXCLUSIONS.files.includes(file)) return;

              if (isDirectory) {
                getHtmlFiles(filePath, fileList);
              } else if (file.endsWith('.html')) {
                let urlPath = filePath
                  .replace(process.cwd(), '')
                  .replace(/\\/g, '/')
                  .replace(/index\.html$/, '');
                
                if (!urlPath.startsWith('/')) urlPath = '/' + urlPath;
                if (!urlPath.endsWith('/')) urlPath = urlPath + '/';
                fileList.push(urlPath);
              }
            });
            return [...new Set(fileList)];
          };

          const allPages = getHtmlFiles(process.cwd());
          const sitemapEntries = allPages.map(page => {
            const settings = CONFIG[page] || { priority: 0.5, changefreq: 'monthly' };
            return `  <url>\n    <loc>${BASE_URL}${page}</loc>\n    <lastmod>${VERSION_DATE}</lastmod>\n    <changefreq>${settings.changefreq}</changefreq>\n    <priority>${settings.priority.toFixed(1)}</priority>\n  </url>`;
          }).join('\n');

          const sitemap = `<?xml version="1.0" encoding="UTF-8"?>\n<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">\n${sitemapEntries}\n</urlset>`;
          
          fs.writeFileSync('sitemap.xml', sitemap);
          console.log(\`Generated sitemap with \${allPages.length} URLs.\`);

      - name: Commit and Push Changes
        run: |
          git config --global user.name "Hassan Biswas (Automation)"
          git config --global user.email "hassanbiswas.github.io@gmail.com"
          
          git add sitemap.xml
          
          # Logic: const VERSION = new Date().getDate();
          VERSION=$(date +'%d')
          
          if ! git diff --cached --quiet; then
            git commit -m "chore: sitemap v$VERSION update $(date +'%Y-%m-%d') [skip ci]"
            git push
          else
            echo "No changes detected. Skipping push."
          fi

      - name: Ping Search Engines
        run: |
          curl "https://www.google.com/ping?sitemap=https://hassanbiswas.github.io/sitemap.xml" || echo "Google ping failed"
          curl "https://www.bing.com/ping?sitemap=https://hassanbiswas.github.io/sitemap.xml" || echo "Bing ping failed"
          
