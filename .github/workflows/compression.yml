name: Automated Compression Logic & Asset Sync
on:
  push:
    branches:
      - main
    paths:
      - '**/*.zip'
      - '**/*.7z'
      - '**/*.tar'
      - '**/*.gz'
      - '**/*.rar'
      - '**/*.bz2'
  # Logic: Automates refresh at the start and middle of every month
  schedule:
    - cron: '0 0 1,15 * *'
  workflow_dispatch:

jobs:
  extract-and-clean:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Process Archives & Preserve Logic
        run: |
          # 1. Version Automation (Cache-busting)
          VERSION=$(date +%d)
          echo "Current Version Logic: $VERSION"
          
          # 2. Define Excluded Names (Fallback Security)
          EXCLUDES=( ".git" ".github" "node_modules" "src" "dist" "app" )
          EXCLUDE_PARAMS=""
          for item in "${EXCLUDES[@]}"; do
            EXCLUDE_PARAMS+=" ! -path '*/$item/*' ! -name '$item'"
          done

          # 3. Find all compressed files (any extension)
          ARCHIVES=$(find . -type f \( -name "*.zip" -o -name "*.7z" -o -name "*.tar" -o -name "*.gz" -o -name "*.rar" -o -name "*.bz2" \) $EXCLUDE_PARAMS)

          if [ -z "$ARCHIVES" ]; then
            echo "No new compressed files found. Skipping extraction."
          else
            echo "Found archives: $ARCHIVES"
            echo "$ARCHIVES" | while read -r ARCHIVE; do
              TARGET_DIR=$(dirname "$ARCHIVE")
              TEMP_EXTRACT="./temp_extract_$(date +%s)"
              
              echo "Extracting $ARCHIVE to $TEMP_EXTRACT..."
              mkdir -p "$TEMP_EXTRACT"

              # Multi-format handling
              if [[ "$ARCHIVE" == *.zip ]]; then unzip -o "$ARCHIVE" -d "$TEMP_EXTRACT";
              elif [[ "$ARCHIVE" == *.7z ]]; then 7z x "$ARCHIVE" -o"$TEMP_EXTRACT" -y;
              elif [[ "$ARCHIVE" == *.rar ]]; then unrar x -o+ "$ARCHIVE" "$TEMP_EXTRACT";
              else tar -xf "$ARCHIVE" -C "$TEMP_EXTRACT"; fi

              # 4. Move, Overwrite, and Delete
              # Move extracted contents to the archive's original path (overwriting duplicates)
              cp -rf "$TEMP_EXTRACT"/* "$TARGET_DIR/"
              
              # Success Check & Cleanup
              if [ $? -eq 0 ]; then
                echo "Move successful. Deleting source archive and temp folder."
                rm -rf "$TEMP_EXTRACT"
                rm -f "$ARCHIVE"
              fi
            done
          fi

      - name: Inject Version Logic into JS
        run: |
          # Automation: Updates const VERSION = new Date().getDate(); in all JS
          # Ensures site logic stays synced with the deployment date
          VERSION=$(date +%d)
          find . -name "*.js" -not -path "*/node_modules/*" -exec sed -i "s/const VERSION = .*/const VERSION = ${VERSION};/g" {} +

      - name: Commit & Push Changes (Zero Maintenance)
        run: |
          git config --global user.name "hassanbiswas"
          git config --global user.email "hassanbiswas.github.io@gmail.com"
          
          git add .
          if git diff --staged --quiet; then
            echo "No changes detected. Logic is already up to date."
          else
            git commit -m "Automated Sync: Version ${VERSION} (Archive Extraction & Version Update)"
            git push
          fi
          
