name: Automated Compression & Logic Preservation
on:
  push:
    branches:
      - main
    paths:
      - '**'
      - '**/*.zip'
      - '**/*.7z'
      - '**/*.tar'
      - '**/*.gz'
      - '**/*.rar'
  # Zero Maintenance: Automates refresh at the start and middle of every month
  schedule:
    - cron: '0 0 1,15 * *'
  workflow_dispatch: 

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Execute Logic & Extraction
        id: extraction_step
        run: |
          # 1. Version Automation (Cache-busting)
          VERSION=$(date +%d)
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # 2. Define Excluded Names (Fallback Security)
          EXCLUDE_LOGIC='! -path "./.git/*" ! -path "./.github/*" ! -name "node_modules"'

          # 3. Find and Process any compressed extension
          ARCHIVES=$(find . -type f \( -name "*.zip" -o -name "*.7z" -o -name "*.tar" -o -name "*.gz" -o -name "*.rar" \) $EXCLUDE_LOGIC)

          if [ -z "$ARCHIVES" ]; then
            echo "No archives found. Proceeding with version sync."
          else
            echo "Found archives: $ARCHIVES"
            echo "$ARCHIVES" | while read -r ARCHIVE; do
              TARGET_PATH=$(dirname "$ARCHIVE")
              TEMP_DIR="./tmp_extract_$(date +%s)"
              mkdir -p "$TEMP_DIR"

              echo "Extracting $ARCHIVE..."
              # Handle various formats
              if [[ "$ARCHIVE" == *.zip ]]; then unzip -o "$ARCHIVE" -d "$TEMP_DIR";
              elif [[ "$ARCHIVE" == *.7z ]]; then 7z x "$ARCHIVE" -o"$TEMP_DIR" -y;
              elif [[ "$ARCHIVE" == *.tar* || "$ARCHIVE" == *.gz ]]; then tar -xf "$ARCHIVE" -C "$TEMP_DIR";
              fi

              # 4. Move & Overwrite: Move contents to the directory where the archive was
              echo "Moving files to $TARGET_PATH and overwriting duplicates..."
              cp -rf "$TEMP_DIR"/. "$TARGET_PATH/"

              # 5. Cleanup: Delete archive and temp folder
              rm -rf "$TEMP_DIR"
              rm -f "$ARCHIVE"
              echo "Cleanup complete for $ARCHIVE"
            done
          fi

      - name: Inject Brand & Version
        run: |
          # Logic Preservation: Update VERSION in all JS files
          # Matches: const VERSION = new Date().getDate();
          find . -name "*.js" -not -path "./.github/*" -exec sed -i "s/const VERSION = .*/const VERSION = ${VERSION};/g" {} +
          
          # Maintain Brand Identity
          echo "BRAND_COLOR='hsl(240, 80%, 50%)'" >> $GITHUB_ENV

      - name: Commit Updated Logic
        run: |
          git config --global user.name "hassanbiswas"
          git config --global user.email "hassanbiswas.github.io@gmail.com"
          git add .
          if ! git diff --staged --quiet; then
            git commit -m "Automated Sync: Version ${VERSION} (Archive Extraction & Cleanup)"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Interactive Log (Zero Cost Notification)
        if: always()
        run: |
          echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version Logic:** ${VERSION} (Cache-busting active)" >> $GITHUB_STEP_SUMMARY
          echo "**Brand Color:** \`hsl(240, 80%, 50%)\`" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¬ Manual Verification" >> $GITHUB_STEP_SUMMARY
          echo "If any issues occur, contact via preferred method:" >> $GITHUB_STEP_SUMMARY
          echo "[Open Messenger: hassanbiswas.github.io](https://m.me/hassanbiswas.github.io)" >> $GITHUB_STEP_SUMMARY

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        
