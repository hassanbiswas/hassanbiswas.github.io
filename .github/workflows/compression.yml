name: Automated Compression Logic & Asset Sync
on:
  push:
    branches:
      - main
    paths:
      - '**/*.zip'
      - '**/*.7z'
      - '**/*.tar'
      - '**/*.gz'
      - '**/*.rar'
      - '**/*.bz2'
  schedule:
    - cron: '0 0 1,15 * *'
  workflow_dispatch:

jobs:
  extract-and-clean:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install Extraction Tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y p7zip-full unrar

      - name: Process Archives & Preserve Logic
        run: |
          # Use Dynamic Date for Cache-Busting Logic
          const_version="const VERSION = $(date +%d);"
          
          # Find and process archives
          find . -type f \( -name "*.zip" -o -name "*.7z" -o -name "*.rar" -o -name "*.tar" -o -name "*.gz" \) \
          -not -path "./.git/*" -not -path "./node_modules/*" | while read -r ARCHIVE; do
            echo "Processing $ARCHIVE..."
            EXTRACT_DIR="temp_$(date +%s)"
            mkdir -p "$EXTRACT_DIR"
            
            if [[ "$ARCHIVE" == *.zip ]] || [[ "$ARCHIVE" == *.7z ]] || [[ "$ARCHIVE" == *.rar ]]; then
              7z x "$ARCHIVE" -o"$EXTRACT_DIR" -y || true
            else
              tar -xf "$ARCHIVE" -C "$EXTRACT_DIR" || true
            fi
            
            # Sync extracted files back to the archive's directory
            TARGET_PATH=$(dirname "$ARCHIVE")
            cp -rn "$EXTRACT_DIR"/* "$TARGET_PATH/" 2>/dev/null || true
            rm -rf "$EXTRACT_DIR"
          done

      - name: Inject Reusable JS Version Logic
        run: |
          # Automates cache-busting by updating the VERSION constant in all JS files
          # Uses the current day of the month as requested
          VERSION_VAL=$(date +%d)
          find . -name "*.js" -not -path "./node_modules/*" -type f -exec sed -i "s/const VERSION = .*;/const VERSION = ${VERSION_VAL};/g" {} + || echo "No matching patterns found."

      - name: Commit & Push Changes
        run: |
          git config --local user.email "hassanbiswas.github.io@gmail.com"
          git config --local user.name "Hassan Biswas"
          git add .
          if ! git diff --cached --quiet; then
            git commit -m "Automated Asset Sync & Logic Preservation [Skip CI]"
            git push origin main
          else
            echo "No changes to commit"
          fi
          
