name: Compression Automation
on:
  schedule:
    - cron: '0 0 1,15 * *'
  workflow_dispatch:

jobs:
  extract-sync-delete:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: [actions/checkout](https://github.com/actions/checkout)@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install Extraction Tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y p7zip-full rsync

      - name: Process, Overwrite, and Remove Archives
        run: |
          # Logic Automation: Pure Bash Cache-busting (Monthly/Bi-weekly trigger)
          VERSION=$(date +%d)
          echo "Current Logic Version: $VERSION"

          # Fallback Security: Safe temp workspace
          TEMP_PARENT="/tmp/ext_assets"
          mkdir -p "$TEMP_PARENT"

          # Optimization: Find archives while strictly ignoring excluded directories
          find . -type d \( -name ".git" -o -name ".github" -o -name "node_modules" -o -name "app" \) -prune -o \
          -type f \( -name "*.zip" -o -name "*.7z" -o -name "*.rar" -o -name "*.tar" -o -name "*.gz" \) \
          -print0 | while IFS= read -r -d '' ARCHIVE; do
            
            # Create a unique extraction folder
            ARCHIVE_NAME=$(basename "$ARCHIVE")
            EXTRACT_DIR="$TEMP_PARENT/${ARCHIVE_NAME//[^a-zA-Z0-9]/}"
            mkdir -p "$EXTRACT_DIR"

            # Extract and Overwrite (-aoa)
            if 7z x "$ARCHIVE" "-o$EXTRACT_DIR" -aoa; then
              TARGET_PATH=$(dirname "$ARCHIVE")

              # Flattening Logic: check if the archive has a single wrapper folder
              # If so, it moves the inner contents out so they land directly where the .zip was placed.
              ITEM_COUNT=$(ls -1 "$EXTRACT_DIR" | wc -l)
              if [ "$ITEM_COUNT" -eq 1 ]; then
                INNER_PATH=$(find "$EXTRACT_DIR" -maxdepth 1 -mindepth 1 -type d)
                if [ -n "$INNER_PATH" ]; then
                  echo "Flattening: Moving contents out of single wrapper folder..."
                  mv "$INNER_PATH"/* "$EXTRACT_DIR/" 2>/dev/null || true
                  mv "$INNER_PATH"/.* "$EXTRACT_DIR/" 2>/dev/null || true
                  rmdir "$INNER_PATH"
                fi
              fi

              # --- STRICT OVERWRITE & PRESERVATION LOGIC ---
              # -a: archive, -v: verbose, -u: update (Logic Preservation)
              rsync -avu \
                --exclude='app/' \
                --exclude='.git/' \
                --exclude='.github/' \
                --exclude='node_modules/' \
                --exclude='package.json' \
                --exclude='package-lock.json' \
                --exclude='.env' \
                --exclude='README.md' \
                "$EXTRACT_DIR/" "$TARGET_PATH/"

              # Automation: Delete source archive after successful sync
              echo "Processed $ARCHIVE. Deleting source..."
              rm -f "$ARCHIVE"
            else
              echo "Error: Failed to extract $ARCHIVE."
            fi

            rm -rf "$EXTRACT_DIR"
          done
          rm -rf "$TEMP_PARENT"

      - name: Commit & Push Changes
        run: |
          git config --local user.email "hassanbiswas.github.io@gmail.com"
          git config --local user.name "Hassan Biswas"

          git add -A

          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Automated Asset Sync & Flattening Logic [skip ci]"
            git push origin main
          else
            echo "No changes detected."
          fi
          
