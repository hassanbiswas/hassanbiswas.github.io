name: 15-Day Automated Backup (No-Workflow Mirror)

on:
  schedule:
    # Logic: Semi-monthly automation (1st and 15th)
    - cron: '0 0 1,15 * *'
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Temporary Token
        id: generate_token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.BACKUP_APP_ID }}
          private-key: ${{ secrets.BACKUP_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Checkout Source (Protected)
        uses: actions/checkout@v4
        with:
          path: source-repo

      - name: Checkout Backup Repo (Destination)
        uses: actions/checkout@v4
        with:
          repository: hassanbiswas/backup
          token: ${{ steps.generate_token.outputs.token }}
          path: backup-repo

      - name: Clean Sync Logic
        run: |
          # 1. We use --exclude to skip .git and .github folders.
          # 2. We use --delete to remove files in backup-repo that no longer exist in source-repo.
          # 3. This command DOES NOT touch your source-repo files.
          rsync -av --delete \
            --exclude='.git/' \
            --exclude='.github/' \
            source-repo/ backup-repo/

      - name: Commit and Push
        run: |
          cd backup-repo
          
          # Git Identity for Bot Automation
          git config user.name "hassanbiswas-backup[bot]"
          git config user.email "hassanbiswas-backup[bot]@users.noreply.github.com"

          # Automated Date-based Revision Logic
          VERSION=$(date +'%d')
          DATE_STAMP=$(date +'%Y-%m-%d')

          git add .

          # Only push if there are changes (Set-and-Forget)
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Backup Revision $VERSION: $DATE_STAMP"
            git push origin main
          else
            echo "Everything is up to date. No push needed."
          fi
          
